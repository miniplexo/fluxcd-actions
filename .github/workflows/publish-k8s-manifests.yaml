name: Publish Kubernetes manifests to Flux build path

on:
  # Reusable workflow that expects manifests via artifact
  workflow_call:
    inputs:
      app_name:
        description: "Application name (defaults to repo name in caller)"
        required: false
        default: ""
        type: string
      artifact_path:
        description: "Relative path to place downloaded manifests before publishing"
        required: false
        default: "build-output"
        type: string
      flux_repo:
        description: "Flux Git repository name"
        required: true
        type: string
    secrets:
      OCI_K3S_FLUX_REPO_ACCESS_TOKEN:
        description: "Flux repo access token"
        required: true

permissions:
  contents: none

jobs:
  publish_k8s_manifests:
    runs-on: ubuntu-latest

    steps:
      - name: Infer app name if not provided
        id: app_name
        run: |
          if [ -z "${{ inputs.app_name }}" ]; then
            echo "App name not provided via input. Falling back to repository name."
            # GitHub passes the caller's repo name in GITHUB_REPOSITORY
            APP_NAME="${GITHUB_REPOSITORY##*/}"
          else
            APP_NAME="${{ inputs.app_name }}"
          fi
          echo "Resolved app name: ${APP_NAME}"
          echo "app_name=${APP_NAME}" >> "$GITHUB_OUTPUT"

      - name: Download manifests artifact
        # Pulls manifests generated by compose-to-k8s workflow
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: ${{ inputs.artifact_path }}

      - name: Verify artifact path exists
        run: |
          echo "Verifying artifact path: '${{ inputs.artifact_path }}'"
          if [ ! -d "${{ inputs.artifact_path }}" ]; then
            echo "ERROR: Artifact path '${{ inputs.artifact_path }}' does not exist after downloading artifact."
            ls -R .
            exit 1
          fi
          echo "Artifact path verified. Contents:"
          ls -R "${{ inputs.artifact_path }}"

      - name: Checkout Flux repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.flux_repo }}
          token: ${{ secrets.OCI_K3S_FLUX_REPO_ACCESS_TOKEN }}
          path: flux-repo

      - name: Copy manifests into build path in Flux repo
        run: |
          set -e
          APP_NAME="${{ steps.app_name.outputs.app_name }}"
          BUILD_PATH="flux-repo/apps/build/${APP_NAME}"

          echo "Publishing manifests for app '${APP_NAME}' to Flux build path: ${BUILD_PATH}"
          mkdir -p "${BUILD_PATH}"

          echo "Clearing existing build path contents for deterministic builds..."
          rm -rf "${BUILD_PATH:?}/"*

          echo "Copying manifests from '${{ inputs.artifact_path }}' to '${BUILD_PATH}'..."
          cp -R "${{ inputs.artifact_path }}/." "${BUILD_PATH}/"

          echo "Final contents of Flux build path:"
          ls -R "${BUILD_PATH}"

      - name: Commit and push build manifests to Flux repo
        run: |
          cd flux-repo
          git config user.name "${{ github.repository_owner }}-github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git status
          git add .

          if git diff --cached --quiet; then
            echo "No changes to commit in Flux repo. Nothing to publish."
            exit 0
          fi

          APP_NAME="${{ steps.app_name.outputs.app_name }}"
          echo "Changes detected. Committing updated manifests for app '${APP_NAME}'..."

          git commit -m "Publish build manifests for ${APP_NAME} from ${GITHUB_SHA}"
          git push
          echo "Flux build manifests pushed successfully."
