name: Delete app from environment

on:
  # This workflow is reusable from app repositories
  workflow_call:
    inputs:
      target_env:
        description: "Environment to delete app from (e.g., dev, prod)"
        required: true
        type: string
      app_name:
        description: "Application name (defaults to repo name)"
        required: false
        default: ${{ github.event.repository.name }}
        type: string

    secrets:
      OCI_K3S_FLUX_REPO_DEPLOY_KEY:
        description: "SSH private deploy key for Flux repo"
        required: true

permissions:
  contents: none

jobs:
  delete_app:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 0. Configure SSH using the Flux deploy key
      # ------------------------------------------------------------
      - name: Configure SSH for Flux deploy key
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCI_K3S_FLUX_REPO_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # ------------------------------------------------------------
      # 1. Checkout Flux GitOps repository
      # ------------------------------------------------------------
      - name: Checkout Flux repository
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.OCI_K3S_FLUX_REPO }}
          ssh-key: ${{ secrets.OCI_K3S_FLUX_REPO_DEPLOY_KEY }}
          path: flux-repo

      # ------------------------------------------------------------
      # 2. Delete app folder + per-app Flux Kustomization CR
      #    Flux prune will remove in-cluster resources automatically.
      # ------------------------------------------------------------
      - name: Delete app from environment
        shell: bash
        run: |
          APP="${{ inputs.app_name }}"
          ENV="${{ inputs.target_env }}"

          APP_PATH="flux-repo/apps/${ENV}/${APP}"
          CR_PATH="flux-repo/clusters/k3s/${ENV}/apps/${APP}.yaml"

          echo "Deleting app '${APP}' from environment '${ENV}'"
          echo "Removing app manifests at: ${APP_PATH}"
          rm -rf "${APP_PATH}"

          echo "Removing app Flux Kustomization at: ${CR_PATH}"
          rm -f "${CR_PATH}"

          echo "Remaining app folders under apps/${ENV}:"
          ls -R "flux-repo/apps/${ENV}" || true

          echo "Remaining CRs under clusters/k3s/${ENV}/apps:"
          ls -R "flux-repo/clusters/k3s/${ENV}/apps" || true

      # ------------------------------------------------------------
      # 3. Commit and push deletion
      # ------------------------------------------------------------
      - name: Commit and push deletion to Flux repo
        shell: bash
        run: |
          cd flux-repo
          git config user.name "${{ github.repository_owner }}-github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Delete app ${{ inputs.app_name }} from ${{ inputs.target_env }}"
          git push
