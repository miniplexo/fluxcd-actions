name: Promote release manifests to environment

on:
  # This workflow is reusable from app repositories.
  # It is always invoked by a deploy workflow (dev, prod, etc.).
  workflow_call:
    inputs:
      app_name:
        description: "Application name (defaults to repo name)"
        required: true
        type: string

      target_env:
        description: "Target logical environment (e.g., dev, prod)"
        required: true
        type: string

      release_tag:
        description: "Release tag to promote"
        required: true
        type: string

    secrets:
      OCI_K3S_FLUX_REPO_DEPLOY_KEY:
        description: "SSH private deploy key for Flux repo"
        required: true

permissions:
  contents: read

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 0. Configure SSH using the deploy key.
      #
      # This ensures repo-scoped, machine-only write access
      # to the Flux GitOps repository.
      # ------------------------------------------------------------
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCI_K3S_FLUX_REPO_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # ------------------------------------------------------------
      # 1. Download release assets.
      #
      # This replaces the old artifact-based model. Releases
      # provide immutable, versioned, long-lived artifacts.
      # ------------------------------------------------------------
      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ inputs.release_tag }}
          fileName: "*"
          out-file-path: release-assets

      # ------------------------------------------------------------
      # 1b. Validate release structure before promotion.
      #
      # This prevents silent bad promotions due to missing files.
      # ------------------------------------------------------------
      - name: Validate release structure
        run: |
          if [ ! -d release-assets/manifests ]; then
            echo "ERROR: manifests/ missing in release"
            exit 1
          fi
          if [ ! -f release-assets/kustomization.yaml ]; then
            echo "ERROR: kustomization.yaml missing in release"
            exit 1
          fi

      # ------------------------------------------------------------
      # 2. Checkout the Flux GitOps repository using SSH + deploy key.
      #
      # The repo name is provided via variable OCI_K3S_FLUX_REPO
      # to keep platform ownership of the GitOps repo.
      # ------------------------------------------------------------
      - name: Checkout Flux repo
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.OCI_K3S_FLUX_REPO }}
          ssh-key: ${{ secrets.OCI_K3S_FLUX_REPO_DEPLOY_KEY }}
          path: flux-repo

      # ------------------------------------------------------------
      # 3. Copy release artifacts into the target environment folder.
      #
      # This ensures apps/<env>/<app> contains ONLY the promoted build.
      # ------------------------------------------------------------
      - name: Promote manifests
        run: |
          DEST="flux-repo/apps/${{ inputs.target_env }}/${{ inputs.app_name }}"
          rm -rf "$DEST"
          mkdir -p "$DEST"
          cp -R release-assets/manifests "$DEST/"
          cp release-assets/kustomization.yaml "$DEST/"

      # ------------------------------------------------------------
      # 4. Generate per-app Flux Kustomization CR.
      #
      # This CR isolates reconciliation to ONLY this app folder.
      # Namespace is derived from the environment: <env>-apps.
      # ------------------------------------------------------------
      - name: Generate Flux Kustomization
        run: |
          FILE="flux-repo/clusters/k3s/${{ inputs.target_env }}/apps/${{ inputs.app_name }}.yaml"
          NS="${{ inputs.target_env }}-apps"
          mkdir -p "$(dirname "$FILE")"

          cat > "$FILE" <<EOF
          apiVersion: kustomize.toolkit.fluxcd.io/v1
          kind: Kustomization
          metadata:
            name: ${{ inputs.app_name }}
            namespace: flux-system
          spec:
            interval: 1m
            path: ./apps/${{ inputs.target_env }}/${{ inputs.app_name }}
            prune: true
            sourceRef:
              kind: GitRepository
              name: flux-system
              namespace: flux-system
            targetNamespace: ${NS}
            wait: true
            timeout: 2m
          EOF

      # ------------------------------------------------------------
      # 5. Commit and push changes to Flux repo using deploy key.
      #
      # This ensures machine-identity commits and prevents
      # human PAT drift or privilege leakage.
      # ------------------------------------------------------------
      - name: Commit & push
        run: |
          cd flux-repo
          git config user.name "${{ github.repository_owner }}-github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add .
          git commit -m "Promote ${{ inputs.app_name }} to ${{ inputs.target_env }} from release ${{ inputs.release_tag }}" || echo "No changes"
          git push
